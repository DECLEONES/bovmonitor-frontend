<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BovMonitor Lite</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#98a0b3; --accent:#57d9a3; --accent-2:#60a5fa;
      --glass: rgba(255,255,255,0.03); --glass-2: rgba(255,255,255,0.02);
      --radius:14px; --maxw:1100px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071025 0%, #071827 100%);color:#e6eef8}
    .app{max-width:var(--maxw);margin:28px auto;padding:20px;display:grid;grid-template-columns:320px 1fr;gap:20px}
    .main-content{padding:0 20px}
    .sidebar{background:var(--card);padding:20px;border-radius:var(--radius);border:1px solid var(--glass)}
    .sidebar-header{text-align:center;margin-bottom:30px}
    .sidebar-header h1{font-size:24px;color:var(--accent);margin:0 0 5px}
    .sidebar-header p{margin:0;color:var(--muted)}
    .menu-item{display:flex;align-items:center;padding:15px;border-radius:10px;margin-bottom:10px;cursor:pointer;transition:background .2s}
    .menu-item:hover,.menu-item.active{background:var(--glass)}
    .menu-item svg{width:22px;height:22px;margin-right:15px;color:var(--accent-2)}
    .logout{margin-top:40px;text-align:center}
    .card{background:var(--card);padding:20px;border-radius:var(--radius);border:1px solid var(--glass);margin-bottom:20px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .header h2{margin:0;font-size:22px}
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;transition:opacity .2s}
    .btn:hover{opacity:0.9}
    .btn-primary{background:var(--accent);color:#0b1220}
    .btn-secondary{background:var(--glass);color:#e6eef8}
    .btn-danger{background:#ef4444;color:#fff}
    .animal-list{max-height:calc(100vh - 200px);overflow-y:auto;padding-right:10px}
    .animal-item{display:flex;align-items:center;padding:15px;border-radius:10px;margin-bottom:10px;cursor:pointer;transition:background .2s;background:var(--glass-2)}
    .animal-item:hover,.animal-item.selected{background:var(--glass)}
    .animal-item-icon{width:40px;height:40px;border-radius:50%;background:var(--accent-2);display:flex;align-items:center;justify-content:center;margin-right:15px;font-weight:bold;font-size:18px}
    .animal-item-details{flex-grow:1}
    .animal-item-details p{margin:0}
    .animal-item-details .name{font-weight:600}
    .animal-item-details .info{color:var(--muted);font-size:14px}
    .animal-details{text-align:center}
    .animal-details .icon-large{width:80px;height:80px;border-radius:50%;background:var(--accent-2);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-weight:bold;font-size:36px}
    .animal-details h3{margin:0 0 5px;font-size:24px}
    .animal-details .category{color:var(--muted);margin-bottom:20px;display:inline-block;background:var(--glass);padding:5px 10px;border-radius:8px}
    .chart-container{height:250px!important}
    .actions button{margin:0 5px}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:var(--card);padding:30px;border-radius:var(--radius);width:90%;max-width:450px;border:1px solid var(--glass)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h2{margin:0}
    .close-btn{background:none;border:none;color:#fff;font-size:24px;cursor:pointer}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;color:var(--muted)}
    .form-group input,.form-group select{width:100%;padding:10px;background:var(--glass);border:1px solid var(--glass-2);border-radius:8px;color:#fff;font-size:15px}
    .login-view{height:100%;display:flex;align-items:center;justify-content:center}
    .login-box{width:100%;max-width:400px;text-align:center}
    .login-box h1{color:var(--accent);font-size:32px}
    .login-box p{color:var(--muted);margin-bottom:30px}
    .login-box .card{text-align:left}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:15px 25px;border-radius:8px;z-index:2000;opacity:0;transition:opacity .3s, bottom .3s;visibility:hidden}
    #toast.show{opacity:1;bottom:30px;visibility:visible}
    #toast.error{background:#ef4444} #toast.success{background:var(--accent);color:#0b1220} #toast.info{background:#3b82f6}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
    .stat-card{text-align:center}
    .stat-card .value{font-size:36px;font-weight:bold;color:var(--accent-2)}
    .stat-card .label{color:var(--muted)}
    .event-list{max-height:calc(100vh - 200px);overflow-y:auto;padding-right:10px}
    .event-item{background:var(--glass-2);padding:15px;border-radius:10px;margin-bottom:10px}
    .event-item-header{display:flex;justify-content:space-between;font-weight:bold;margin-bottom:5px}
    .event-item .date{color:var(--accent-2)}
    .event-item .description{color:var(--muted)}
    input[type=search]{width:250px;padding:10px 15px;background:var(--glass);border:1px solid var(--glass-2);border-radius:8px;color:#fff;font-size:15px;margin-right:10px}
  </style>
</head>
<body>

  <div id="login-view">
    <div class="login-box">
      <h1>BovMonitor Lite</h1>
      <p>Gestão de rebanho simplificada.</p>
      <div class="card">
        <form id="login-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" required>
          </div>
          <div class="form-group">
            <label for="password">Senha</label>
            <input type="password" id="password" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%">Entrar</button>
        </form>
      </div>
    </div>
  </div>

  <div id="app-view" style="display:none;" class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1 id="user-name"></h1>
        <p>Bem-vindo(a)</p>
      </div>
      <nav>
        <div id="btn-menu-dashboard" class="menu-item active">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 1.5m-5-1.5l1-1.5m9-5.25l.375-1.5a.75.75 0 011.498-.058l.375 1.5a.75.75 0 01-.67 1.05l-1.5.375a.75.75 0 01-1.05-.67zM12 6.75L11.625 5.25a.75.75 0 011.498-.058L12 6.75z"/></svg>
          <span>Dashboard</span>
        </div>
        <div id="btn-menu-rebanho" class="menu-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75L16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z"/></svg>
            <span>Rebanho</span>
        </div>
        <div id="btn-menu-calendario" class="menu-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 11.25h.008v.008H12v-.008z"/></svg>
            <span>Calendário</span>
        </div>
      </nav>
      <div class="logout">
        <button id="btn-logout" class="btn btn-secondary">Sair</button>
      </div>
    </aside>

    <main class="main-content">
      <div id="dashboard-view">
        <div class="header">
          <h2>Dashboard</h2>
        </div>
        <div class="stats-grid">
            <div class="card stat-card">
                <div id="total-animals" class="value">0</div>
                <div class="label">Total de Animais</div>
            </div>
            <div class="card stat-card">
                <div id="male-count" class="value">0</div>
                <div class="label">Machos</div>
            </div>
            <div class="card stat-card">
                <div id="female-count" class="value">0</div>
                <div class="label">Fêmeas</div>
            </div>
        </div>
        <div class="card">
            <h3>Distribuição por Categoria</h3>
            <div style="height:300px"><canvas id="category-chart"></canvas></div>
        </div>
      </div>

      <div id="rebanho-view" style="display:none;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <div class="header">
                <h2>Meu Rebanho</h2>
                <div>
                  <input type="search" id="search" placeholder="Buscar por nome...">
                  <button id="btn-add" class="btn btn-primary">Cadastrar Animal</button>
                </div>
              </div>
              <div class="animal-list" id="animal-list"></div>
            </div>
            <div class="animal-details" id="animal-details-view" style="display:none;">
              <div class="card">
                <div id="details-icon" class="icon-large"></div>
                <h3 id="details-name"></h3>
                <span id="details-category" class="category"></span>
                <div class="actions">
                  <button id="btn-edit" class="btn btn-secondary">Editar</button>
                  <button id="btn-delete" class="btn btn-danger">Excluir</button>
                </div>
              </div>
              <div class="card">
                  <h3>Histórico de Peso</h3>
                  <div class="chart-container">
                    <canvas id="weight-chart"></canvas>
                  </div>
                  <div style="display:flex; margin-top: 15px;">
                    <input type="number" id="weight-input" placeholder="Novo peso (kg)" style="flex-grow:1; margin-right:10px;">
                    <button id="btn-add-weight" class="btn btn-primary">Adicionar</button>
                  </div>
              </div>
            </div>
            <div id="no-animal-selected" class="card" style="display:flex;align-items:center;justify-content:center;flex-direction:column;min-height:400px;color:var(--muted)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:60px;height:60px;margin-bottom:15px"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                <p>Selecione um animal para ver os detalhes.</p>
            </div>
        </div>
      </div>

      <div id="calendario-view" style="display:none;">
        <div class="header">
          <h2>Eventos Futuros</h2>
          <button id="btn-add-event" class="btn btn-primary">Adicionar Evento</button>
        </div>
        <div class="event-list" id="event-list"></div>
      </div>
    </main>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <button class="close-btn">&times;</button>
      </div>
      <form id="modal-form">
        <input type="hidden" id="animal-id">
        <div class="form-group">
          <label for="name">Nome / Identificador</label>
          <input type="text" id="name" required>
        </div>
        <div class="form-group">
          <label for="sex">Sexo</label>
          <select id="sex" required>
            <option value="Macho">Macho</option>
            <option value="Fêmea">Fêmea</option>
          </select>
        </div>
        <div class="form-group">
          <label for="category">Categoria</label>
          <input type="text" id="category" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%"></button>
      </form>
    </div>
  </div>

  <div id="event-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="event-modal-title">Adicionar Evento</h2>
        <button class="close-btn">&times;</button>
      </div>
      <form id="event-modal-form">
        <div class="form-group">
          <label for="e-title">Título</label>
          <input type="text" id="e-title" required>
        </div>
        <div class="form-group">
          <label for="e-description">Descrição</label>
          <input type="text" id="e-description">
        </div>
        <div class="form-group">
          <label for="e-date">Data</label>
          <input type="date" id="e-date" required>
        </div>
        <div class="form-group">
          <label for="e-type">Tipo</label>
          <select id="e-type">
              <option value="Manejo">Manejo</option>
              <option value="Saúde">Saúde</option>
              <option value="Reprodução">Reprodução</option>
              <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="form-group">
            <label for="e-animal-id">Animal (Opcional)</label>
            <select id="e-animal-id"><option value="">Geral</option></select>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%">Salvar Evento</button>
      </form>
    </div>
  </div>

  <div id="toast"></div>

<script>
    // --- SELETORES E CONSTANTES ---
    const $ = (selector) => document.querySelector(selector);
    const API_URL = 'https://bovmonitor-api.onrender.com/api';
    const TOKEN_KEY = 'bovmonitor_token';
    const USER_KEY = 'bovmonitor_user';

    // --- ESTADO DA APLICAÇÃO ---
    let state = {
        token: null,
        user: null,
        animals: [],
        events: [],
        selectedId: null,
        charts: {}
    };

    // --- FUNÇÕES AUXILIARES ---
    function showToast(message, type = 'info') {
        const toast = $('#toast');
        toast.textContent = message;
        toast.className = 'show';
        toast.classList.add(type);
        setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
    }

    function showView(viewId) {
        ['login-view', 'app-view'].forEach(id => $(`#${id}`).style.display = 'none');
        $(`#${viewId}`).style.display = viewId === 'app-view' ? 'grid' : 'flex';
    }

    function showMainView(viewId) {
        ['dashboard-view', 'rebanho-view', 'calendario-view'].forEach(id => $(`#${id}`).style.display = 'none');
        $(`#${viewId}`).style.display = 'block';
        ['dashboard', 'rebanho', 'calendario'].forEach(id => $(`#btn-menu-${id}`).classList.remove('active'));
        $(`#btn-menu-${viewId.split('-')[0]}`).classList.add('active');

        // VERIFICAÇÃO: Lógica de visibilidade dos botões de ação principais
        const btnAddAnimal = $('#btn-add');
        const btnAddEvent = $('#btn-add-event');
        const searchBar = $('#search');
        const isAdmin = state.user && state.user.role === 'ADMIN';

        // Esconde todos os botões de ação por padrão
        btnAddAnimal.style.display = 'none';
        btnAddEvent.style.display = 'none';
        searchBar.style.display = 'none';
        
        if (viewId === 'rebanho-view') {
            searchBar.style.display = 'inline-block';
            if (isAdmin) {
                btnAddAnimal.style.display = 'inline-block';
            }
        } else if (viewId === 'calendario-view') {
            if (isAdmin) {
                btnAddEvent.style.display = 'inline-block';
            }
        }
    }

    function showModal(modalId, animal = null) {
        const modal = $(`#${modalId}`);
        modal.style.display = 'flex';
        if (animal) {
            $('#modal-title').textContent = 'Editar Animal';
            $('#animal-id').value = animal.id;
            $('#name').value = animal.name;
            $('#sex').value = animal.sex;
            $('#category').value = animal.category;
            $('#modal-form button').textContent = 'Salvar Alterações';
        } else {
            $('#modal-title').textContent = 'Cadastrar Novo Animal';
            $('#modal-form').reset();
            $('#animal-id').value = '';
            $('#modal-form button').textContent = 'Cadastrar';
        }
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO ---
    function renderList(searchTerm = '') {
        const listEl = $('#animal-list');
        listEl.innerHTML = '';
        const filteredAnimals = state.animals.filter(a => a.name.toLowerCase().includes(searchTerm.toLowerCase()));
        
        if (filteredAnimals.length === 0) {
            listEl.innerHTML = '<p style="text-align:center;color:var(--muted)">Nenhum animal encontrado.</p>';
            return;
        }

        filteredAnimals.forEach(animal => {
            const item = document.createElement('div');
            item.className = `animal-item ${state.selectedId === animal.id ? 'selected' : ''}`;
            item.innerHTML = `
                <div class="animal-item-icon">${animal.name.charAt(0).toUpperCase()}</div>
                <div class="animal-item-details">
                    <p class="name">${animal.name}</p>
                    <p class="info">${animal.sex} - ${animal.category}</p>
                </div>`;
            item.addEventListener('click', () => selectAnimal(animal.id));
            listEl.appendChild(item);
        });
    }

    async function selectAnimal(id) {
        state.selectedId = id;
        renderList($('#search').value); // Re-renderiza para destacar o item
        const animal = state.animals.find(a => a.id === id);
        if (!animal) return;

        $('#no-animal-selected').style.display = 'none';
        $('#animal-details-view').style.display = 'block';
        $('#details-icon').textContent = animal.name.charAt(0).toUpperCase();
        $('#details-name').textContent = animal.name;
        $('#details-category').textContent = animal.category;

        const btnEdit = $('#btn-edit'), btnDelete = $('#btn-delete');
        
        // VERIFICAÇÃO: Apenas mostra os botões se o utilizador for ADMIN
        if (state.user && state.user.role === 'ADMIN') {
            btnEdit.style.display = 'inline-block';
            btnDelete.style.display = 'inline-block';
        } else {
            btnEdit.style.display = 'none';
            btnDelete.style.display = 'none';
        }

        const weights = await getWeightsAPI(id);
        renderWeightChart(weights);
    }
    
    function renderWeightChart(weights = []) {
        const ctx = $('#weight-chart').getContext('2d');
        if (state.charts.weight) state.charts.weight.destroy();
        
        state.charts.weight = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weights.map(w => new Date(w.weighing_date).toLocaleDateString()),
                datasets: [{
                    label: 'Peso (kg)',
                    data: weights.map(w => w.weight),
                    borderColor: 'rgba(87, 217, 163, 1)',
                    backgroundColor: 'rgba(87, 217, 163, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
        });
    }

    function renderDashboardCharts(dashboardData) {
        const categoryCtx = $('#category-chart').getContext('2d');
        if(state.charts.category) state.charts.category.destroy();

        const categories = dashboardData.byCategory.map(c => c.category);
        const counts = dashboardData.byCategory.map(c => c.count);

        state.charts.category = new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Animais',
                    data: counts,
                    backgroundColor: ['#60a5fa', '#f87171', '#fbbf24', '#a78bfa', '#4ade80'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderEvents() {
        const listEl = $('#event-list');
        listEl.innerHTML = '';
        if (state.events.length === 0) {
            listEl.innerHTML = '<p style="text-align:center;color:var(--muted)">Nenhum evento agendado.</p>';
            return;
        }
        state.events.forEach(event => {
            const item = document.createElement('div');
            item.className = 'event-item';
            item.innerHTML = `
                <div class="event-item-header">
                    <span>${event.title}</span>
                    <span class="date">${new Date(event.event_date).toLocaleDateString()}</span>
                </div>
                <p class="description">${event.description || 'Sem descrição.'}</p>`;
            listEl.appendChild(item);
        });

        // Preenche o dropdown de animais no modal de eventos
        const animalSelect = $('#e-animal-id');
        animalSelect.innerHTML = '<option value="">Geral</option>';
        state.animals.forEach(a => {
            const option = document.createElement('option');
            option.value = a.id;
            option.textContent = a.name;
            animalSelect.appendChild(option);
        });
    }

    // --- FUNÇÕES DA API ---
    async function apiRequest(endpoint, method = 'GET', body = null) {
        try {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (state.token) {
                options.headers['Authorization'] = `Bearer ${state.token}`;
            }
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            return response.status === 204 ? null : response.json();
        } catch (error) {
            showToast(error.message, 'error');
            if (error.message.includes('Token')) logout();
            return null;
        }
    }

    async function loginAPI(email, password) {
        const data = await apiRequest('/sessions', 'POST', { email, password });
        if (data) {
            state.token = data.token;
            state.user = data.user;
            localStorage.setItem(TOKEN_KEY, data.token);
            localStorage.setItem(USER_KEY, JSON.stringify(data.user));
            return true;
        }
        return false;
    }

    async function loadFromAPI() {
        state.animals = await apiRequest('/animals') || [];
        state.events = await apiRequest('/events') || [];
        renderList();
        renderEvents();
    }
    
    async function createOrUpdateAnimalAPI(animalData) {
        const endpoint = animalData.id ? `/animals/${animalData.id}` : '/animals';
        const method = animalData.id ? 'PUT' : 'POST';
        const newData = await apiRequest(endpoint, method, animalData);
        if (newData) {
            showToast(`Animal ${animalData.id ? 'atualizado' : 'cadastrado'} com sucesso!`, 'success');
            await loadFromAPI();
            if(!animalData.id) selectAnimal(newData.id);
            return true;
        }
        return false;
    }

    async function deleteAnimalAPI(id) {
        if (!confirm('Tem certeza que deseja excluir este animal e todos os seus registros?')) return false;
        await apiRequest(`/animals/${id}`, 'DELETE');
        showToast('Animal excluído com sucesso!', 'success');
        state.selectedId = null;
        $('#animal-details-view').style.display = 'none';
        $('#no-animal-selected').style.display = 'flex';
        await loadFromAPI();
        return true;
    }

    async function getWeightsAPI(animalId) {
        return await apiRequest(`/animals/${animalId}/weights`) || [];
    }
    
    async function addWeightAPI(animalId, weightData) {
        const newWeight = await apiRequest(`/animals/${animalId}/weights`, 'POST', { weight: weightData.weight, weighing_date: weightData.date });
        if(newWeight) {
            showToast('Peso adicionado com sucesso!', 'success');
            const weights = await getWeightsAPI(animalId);
            renderWeightChart(weights);
            return true;
        }
        return false;
    }

    async function loadDashboardData() {
        const data = await apiRequest('/dashboard');
        if (data) {
            $('#total-animals').textContent = data.total;
            $('#male-count').textContent = data.males;
            $('#female-count').textContent = data.females;
            renderDashboardCharts(data);
        }
    }

    async function createEventAPI(eventData) {
        const newEvent = await apiRequest('/events', 'POST', eventData);
        if(newEvent) {
            showToast('Evento criado com sucesso!', 'success');
            await loadFromAPI(); // Recarrega animais e eventos
            return true;
        }
        return false;
    }

    function logout() {
        state.token = null;
        state.user = null;
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(USER_KEY);
        showView('login-view');
    }

    // --- EVENT LISTENERS ---
    $('#login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = $('#email').value;
        const password = $('#password').value;
        const success = await loginAPI(email, password);
        if (success) {
            initApp();
        }
    });

    $('#btn-logout').addEventListener('click', logout);
    $('#btn-menu-dashboard').addEventListener('click', () => showMainView('dashboard-view'));
    $('#btn-menu-rebanho').addEventListener('click', () => showMainView('rebanho-view'));
    $('#btn-menu-calendario').addEventListener('click', () => showMainView('calendario-view'));
    $('#btn-add').addEventListener('click', () => showModal('#modal'));
    $('#btn-edit').addEventListener('click', () => {
        if (!state.selectedId) return;
        const animal = state.animals.find(a => a.id === state.selectedId);
        showModal('#modal', animal);
    });
    $('#btn-delete').addEventListener('click', () => {
        if (state.selectedId) deleteAnimalAPI(state.selectedId);
    });
    $('#modal-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const animalData = { id: $('#animal-id').value || null, name: $('#name').value.trim(), sex: $('#sex').value, category: $('#category').value.trim() };
        const success = await createOrUpdateAnimalAPI(animalData);
        if (success) $('#modal').style.display = 'none';
    });
    document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => {
        $('#modal').style.display = 'none';
        $('#event-modal').style.display = 'none';
    }));
    
    $('#btn-add-event').addEventListener('click', () => $('#event-modal').style.display = 'flex');
    $('#event-modal-form').addEventListener('submit', async (e) => { e.preventDefault(); const eventData = { title: $('#e-title').value.trim(), description: $('#e-description').value.trim(), event_date: $('#e-date').value, type: $('#e-type').value, animal_id: $('#e-animal-id').value || null }; const success = await createEventAPI(eventData); if(success) $('#event-modal').style.display = 'none'; });
    $('#search').addEventListener('input', (e) => renderList(e.target.value));
    $('#btn-add-weight').addEventListener('click', async () => { if (!state.selectedId) return showToast('Selecione um animal.', 'info'); const weightInput = $('#weight-input'); const weight = parseFloat(weightInput.value); if (!weight || weight <= 0) return showToast('Insira um peso válido.', 'error'); const weightData = { weight: weight, date: new Date().toISOString().split('T')[0] }; const success = await addWeightAPI(state.selectedId, weightData); if(success) weightInput.value = ''; });

    // --- INICIALIZAÇÃO DA APLICAÇÃO ---
    async function initApp() {
        state.token = localStorage.getItem(TOKEN_KEY);
        const userJSON = localStorage.getItem(USER_KEY);
        if (state.token && userJSON) {
            state.user = JSON.parse(userJSON);
            $('#user-name').textContent = state.user.name;
            showView('app-view');
            showMainView('dashboard-view');
            // Carrega os dados em paralelo para uma inicialização mais rápida
            await Promise.all([loadDashboardData(), loadFromAPI()]);
        } else {
            showView('login-view');
        }
    }

    initApp();

</script>
</body>
</html>